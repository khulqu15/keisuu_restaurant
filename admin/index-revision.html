<!DOCTYPE html>
<html data-theme="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashier - Payment Service</title>
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="../style/icon.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="drawer lg:drawer-open">
    <input id="my-drawer" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col items-center justify-center">
      <div class="w-full min-h-screen lg:pl-6 pl-3 pr-3 bg-orange-100">
        <div class="w-full p-3 bg-white rounded-b-2xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <label for="my-drawer" class="btn btn-sm bg-orange-500 drawer-button lg:hidden">
              <span class="jam--menu"></span>
            </label>
            <h1 class="font-bold">Shwe Kan Kaw</h1>
          </div>
          <div>
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="btn m-1 bg-white shadow-none hover:bg-white btn-sm">
                <div class="w-8 h-8 flex items-center bg-orange-500 rounded-full justify-center">
                  <span class="flowbite--user-solid"></span>
                </div>
              </div>
              <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                <li><a>Profile</a></li>
                <li><a>Edit Profile</a></li>
                <li><a>Logout</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mt-6 grid lg:grid-cols-2 grid-cols-1 gap-3">
          <div>
            <div class="grid grid-cols-4 gap-3 mb-3">
              <div>
                <div class="bg-orange-500 py-2 p-4 rounded-xl text-white">
                  Foods
                  <div class="text-3xl" id="food-count">10</div>
                </div>
              </div>
              <div>
                <div class="bg-orange-500 py-2 p-4 rounded-xl text-white">
                  Orders
                  <div class="text-3xl" id="food-count">10</div>
                </div>
              </div>
              <div>
                <div class="bg-orange-500 py-2 p-4 rounded-xl text-white">
                  Restaurants
                  <div class="text-3xl" id="food-count">10</div>
                </div>
              </div>
              <div>
                <div class="bg-orange-500 py-2 p-4 rounded-xl text-white">
                  Staffs
                  <div class="text-3xl" id="food-count">10</div>
                </div>
              </div>
            </div>
            <div class="w-full bg-white p-4 rounded-xl">
              <div class="grid md:grid-cols-2 grid-cols-1 gap-2 items-center">
                <div>
                  <div class="px-3 py-1 bg-orange-500 inline-block rounded-lg text-white">
                    <div class="flex items-center gap-2">
                      <span class="lets-icons--order"></span> Order List
                    </div>
                  </div>
                </div>
                <div class="flex justify-end items-center gap-2">
                  <select id="date-input" class="select select-bordered input-sm w-48">
                    <option selected>Today</option>
                    <option>1 Week</option>
                    <option>1 Month</option>
                    <option>1 Year</option>
                  </select>
  
                  <select id="sort-input" class="select select-bordered input-sm w-48">
                    <option selected>Newest</option>
                    <option>Oldest</option>
                  </select>
                </div>
              </div>
              <div class="overflow-x-auto mt-5">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Table</th>
                      <th>Foods</th>
                      <th>Total Price</th>
                      <th>Payment Status</th>
                    </tr>
                  </thead>
                  <tbody id="table-body">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div>
            <div class="w-full bg-white p-4 rounded-xl">
              <div class="grid md:grid-cols-2 grid-cols-1 gap-2 items-center">
                <div>
                  <div class="px-3 py-1 bg-orange-500 inline-block rounded-lg text-white">
                    <div class="flex items-center gap-2 py-2">
                      <span class="ion--restaurant"></span> Restaurant
                    </div>
                  </div>
                </div>
              </div>
              <div class="overflow-x-auto mt-5">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="restaurant-body">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> 
    <div class="drawer-side">
      <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
      <ul class="menu p-4 w-80 min-h-full bg-white rounded-r-xl text-base-content">
        <li><a class="bg-orange-500 text-white" href="index-revision.html"><span class="solar--home-2-bold"></span> Home</a></li>
        <div class="divider">Admin</div>
        <li><a><span class="ion--restaurant"></span> Restaurants</a></li>
        <li><a><span class="fa6-solid--user-tie"></span> Staffs</a></li>
        <li><a><span class="mdi--food"></span> Foods</a></li>
        <li><a><span class="solar--user-heart-rounded-bold"></span> Customer</a></li>
        <div class="divider">Cashier</div>
        <li><a href="cashier-revision.html">Orders</a></li>
        <li><a>Payments</a></li>
      </ul>
    </div>
  </div>
</body>
</html>

<script>
let dateInput = document.getElementById('date-input')
let sortInput = document.getElementById('sort-input')
let fetch_header = {
  'Accept': 'application/json',
  'Content-Type': 'application/json'
}
let domain_endpoint = 'http://localhost:8000'
let table_body = document.getElementById('table-body')
let restaurant_body = document.getElementById('restaurant-body')

function checkoutOrder(id, customer, restaurant, table, time, status) {
  fetch(domain_endpoint+'/api/admin/food_orders/'+id+'/', {
    method: 'PUT',
    headers: fetch_header,
    body: JSON.stringify({
      restaurant: restaurant,
      customer: customer,
      table: table,
      status: status,
      order_time: time
    })
  })
  .then((response) => { return response.json() })
  .then((data) => {
    if(data.status == 'success') {
      table_body.innerHTML = ``
      getData()
    }
  })
}

function getData() {
  let table_body_content = ''
  fetch(domain_endpoint+'/api/1/chef/orders/', {
    method: 'GET',
    headers: fetch_header
  })
  .then((response) => { return response.json() })
  .then((data) => {
    if(data.status == 'success') {
      if(data.data.length > 0) {
        data.data.map((element, index) => {
          table_body_content += `
          <tr class="hover">
            <th>${element.table.number}</th>
            <td>`
          element.items.map((el, idx) => {
            let food = element.foods.find((item) => item.id == el.food)
            if(food) {
              table_body_content += `<div class="mt-1 flex items-center gap-2">
                <div class="bg-orange-500 inline-block p-1 text-white rounded text-xs">${el.quantity}X</div>
                <span>${food.name}</span>
              </div>`
            }
          })
          table_body_content += `</td><td>`
          let subtotal = 0
          console.log(element)
          element.items.map((el, idx) => {
            subtotal += parseFloat(el.subtotal)
          })
          table_body_content += `<div>${new Intl.NumberFormat('ja-JP').format(subtotal + 100)} Yen</div></td><td>`
          if(element.status == 'pending') {
            table_body_content += `<button onclick="checkoutOrder(${element.id}, ${element.customer.id}, ${element.customer.restaurant}, ${element.table.id}, '${element.order_time}', 'completed')" class="btn bg-orange-500 btn-sm text-white animate-pulse">Checkout</button>`
          } else {
            table_body_content += `<div  onclick="checkoutOrder(${element.id}, ${element.customer.id}, ${element.customer.restaurant}, ${element.table.id}, '${element.order_time}', 'pending')" class="bg-red-500 text-white px-6 py-1 rounded-lg inline-block">Paid</div>`
          }
          table_body_content += `</td>
          </tr>`
        })
      } else {
        table_body_content += `<tr><td colspan="4">
          <div class="w-full p-3 bg-red-500 text-white rounded-xl">Order Not Found</div>
        </td></td>`
      }
      table_body.innerHTML = table_body_content
    }
  })
}

function getRestaurant() {
  fetch(domain_endpoint+'/api/admin/restaurants/', {
    method: 'GET',
    headers: fetch_header,
  })
  .then((response) => { return response.json() })
  .then((data) => {
    if(data.status == 'success') {
      let restaurant_body_html = ''
      if(data.data.length > 0) {
        data.data.map((element, index) => {
          restaurant_body_html += `<tr>
            <td>${element.code == '' ? element.id : element.code}</td>
            <td>${element.name}, ${element.address}</td>
            <td>${formattedDate(element.created_at)}</td>
            <td>
              <div class="flex items-center gap-2">
                <button class="btn-sm btn bg-green-500 text-white text-sm">Detail</button>
                <button class="btn-sm btn bg-red-500 text-white text-sm">Delete</button>
              </div>
            </td>
          </tr>`
        })
      }
      restaurant_body.innerHTML = restaurant_body_html
    }
  })
}

function formattedDate(isoDate) {
  date = new Date(isoDate)
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const formattedDate = `${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}-${year}`;
  return formattedDate
}

document.addEventListener('DOMContentLoaded', () => {
  getData()
  getRestaurant()

})

</script>