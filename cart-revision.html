<!DOCTYPE html>
<html data-theme="light">

<head>
  <title>Food Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style/daisy.min.css" />
  <!-- Add Swiper CSS -->
  
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="style/icon.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="translation.js" type="text/javascript" defer></script>
</head>

<body>
  <div class="max-h-screen flex overflow-hidden justify-center">
    <div class="max-w-lg overflow-x-hidden relative bg-orange-100 w-full min-h-screen">
    
      <div class="max-w-lg w-full bg-white rounded-b-xl shadow-lg grid grid-cols-2 items-center gap-x-2">
        <div class="py-2 px-4">
          <h2 class="font-semibold">Shwe Kan Kaw</h2>
        </div>
        <div class="p-2 flex items-center gap-2 justify-end">
          <div onclick="window.location.href = 'cart-revision.html'" id="food-cart-button" class="btn relative overflow-visible btn-sm text-white bg-orange-500">
            <span class="solar--cart-bold"></span> <span id="food-cart">Food Cart</span>
          </div>
          <label for="exit_modal" id="exit_modal_btn" class="btn btn-sm bg-red-500 text-white">
            <span class="ant-design--logout-outlined"></span> Exit
          </label>
        </div>
      </div>

      <input type="checkbox" id="exit_modal" class="modal-toggle">
      <div class="modal" role="dialog">
        <div class="modal-box max-w-sm">
          <label for="exit_modal" class="btn absolute right-0 top-0"><span class="solar--close-square-bold"></span></label>
          <div class="text-center pt-5">
            <div class="flex w-full items-center justify-center">
              <div class="w-8 h-8 rounded-full bg-red-500 text-white justify-center flex items-center">
                <span class="ant-design--logout-outlined"></span>
              </div>
            </div>
            <h3 class="font-bold text-lg">You wanna exit ?</h3>
            <p class="pb-4 pt-1">If you exit, you will lost your table and foods</p>
          </div>
          <div class="modal-action grid grid-cols-2">
            <div>
              <label for="exit_modal" class="btn w-full">Cancel</label>
            </div>
            <div>
              <label for="exit_modal" class="btn bg-red-500 text-white w-full" onclick="exitFromRestaurant()">Exit now</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Caraousel Slider -->
      <div class="carousel w-full h-32">
        <div id="slide1" class="carousel-item relative w-full">
          <img src="img/banner1.jpg" class="w-full h-full object-center object-cover" alt="Image Banner">
          <div class="absolute flex justify-between transform -translate-1/2 left-5 right-5 top-1/2">
            <a href="#slide2" class="btn btn-circle opacity-60 btn-sm">❮</a> 
            <a href="#slide2" class="btn btn-circle opacity-60 btn-sm">❯</a>
          </div>
        </div>
        <div id="slide2" class="carousel-item relative w-full">
          <img src="img/banner2.jpg" class="w-full h-full object-center object-cover" alt="Image Banner">
          <div class="absolute flex justify-between transform -translate-1/2 left-5 right-5 top-1/2">
            <a href="#slide1" class="btn btn-circle opacity-60 btn-sm">❮</a> 
            <a href="#slide1" class="btn btn-circle opacity-60 btn-sm">❯</a>
          </div>
        </div>
      </div>

      <div class="w-full min-h-[72vh] pb-32 bg-gradient-to-b from-orange-200 to-orange-100 p-4">
        <div class="bg-orange-500 inline-block px-4 py-2 rounded-xl text-white font-bold mb-2">
            <div class="flex items-center gap-x-3">
                <span class="fluent--receipt-16-filled"></span> <span id="your_order_list">Your Order List</span>
            </div>
        </div>
        <div id="cart-content">
          <div class="p-3 rounded-xl bg-white">
              
          </div>
        </div>
        <div class="flex items-center justify-end mt-3" id="submit-button">
            <label for="submit_modal" class="w-1/2 btn bg-black text-white btn-sm rounded-xl border-0 hover:bg-black"><span class="mingcute--send-fill"></span> <span id="submit">Submit</span></label>
        </div>
      </div>

      <div id="jp-lang" class="absolute transition-all bottom-0 opacity-0 right-32">
        <button onclick="changeLang('ja')" class="btn w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 flex items-center justify-center text-white shadow-xl">JP</button>
      </div>
      <div id="en-lang" class="absolute transition-all bottom-0 opacity-0 right-32">
        <button onclick="changeLang('en')" class="btn w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 flex items-center justify-center text-white shadow-xl">EN</button>
      </div>
      <div id="mm-lang" class="absolute transition-all bottom-0 opacity-0 right-32">
        <button onclick="changeLang('mm')" class="btn w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 flex items-center justify-center text-white shadow-xl">MM</button>
      </div>  
      
      <div id="table-pin-content" class="transition-all absolute right-4 bottom-16 z-[15] hidden">
        <div class="absolute right-6 -top-4 w-12 h-6 bg-orange-500 rounded-t-2xl">
          <div class="absolute w-3 h-2 top-2 left-4 rounded-xl bg-orange-100"></div>
        </div>
        <div class="absolute right-5 -top-9">
          <img src="img/pin.png" class="w-8" alt="">
        </div>
        <div class="w-24 h-20 rounded-xl bg-white">
          <div class="w-full p-1 text-white rounded-lg bg-orange-500 flex justify-between items-center">
            <span class="text-sm ml-2" id="table-content">Table</span>
            <button class="p-1 py-0 bg-orange-500" id="table-pin-button">
              <span id="table-pin-button-icon" class="transition-all mingcute--down-fill"></span>
            </button>
          </div>
          <div class="text-4xl flex items-center justify-center font-semibold h-1/2" id="table_number">07</div>
        </div>
      </div>

      <input type="checkbox" id="delete_modal" class="modal-toggle">
      <div class="modal" role="dialog">
        <div class="modal-box max-w-sm">
          <label for="delete_modal" class="btn absolute right-0 top-0"><span class="solar--close-square-bold"></span></label>
          <div class="text-center pt-5">
            <div class="flex w-full items-center justify-center">
              <div class="w-8 h-8 rounded-full bg-red-500 text-white justify-center flex items-center">
                <span class="fluent--delete-12-filled"></span>
              </div>
            </div>
            <h3 class="font-bold text-lg">Are you sure for delete ?</h3>
            <p class="pb-4 pt-1">The food will be removed from food cart</p>
          </div>
          <div class="modal-action grid grid-cols-2">
            <div>
              <label for="delete_modal" class="btn w-full">Cancel</label>
            </div>
            <div>
              <label for="delete_modal" onclick="removeFood()" class="btn bg-red-500 text-white w-full">Remove</label>
            </div>
          </div>
        </div>
      </div>

      <input type="checkbox" id="submit_modal" class="modal-toggle">
      <div class="modal" role="dialog">
        <div class="modal-box max-w-sm">
          <label for="submit_modal" class="btn absolute right-0 top-0"><span class="solar--close-square-bold"></span></label>
          <div class="text-center pt-5">
            <div class="flex w-full items-center justify-center">
              <div class="w-8 h-8 rounded-full bg-green-500 text-white justify-center flex items-center">
                <span class="mingcute--send-fill"></span>
              </div>
            </div>
            <h3 class="font-bold text-lg">Are you sure for submit ?</h3>
            <p class="pb-4 pt-1">The food will be submitted</p>
          </div>
          <div class="modal-action grid grid-cols-2">
            <div>
              <label for="submit_modal" class="btn w-full">Cancel</label>
            </div>
            <div>
              <label for="submit_modal" class="btn bg-green-500 text-white w-full" onclick="submitCart()">Submit</label>
            </div>
          </div>
        </div>
      </div>

      <input type="checkbox" id="submitted_modal" class="modal-toggle">
      <div class="modal" role="dialog">
        <div class="modal-box max-w-sm">
          <div class="text-center pt-5">
            <div class="flex w-full items-center justify-center">
              <div class="w-8 h-8 rounded-full bg-green-500 text-white justify-center flex items-center">
                <span class="mingcute--send-fill"></span>
              </div>
            </div>
            <h3 class="font-bold text-lg">Your order has been submitted</h3>
            <p class="pb-4 pt-1">Please waiting, we will process your order</p>
          </div>
          <div class="modal-action grid grid-cols-1">
            <div>
              <label for="submitted_modal" class="btn bg-green-500 text-white w-full" onclick="window.location.href = 'checkout-revision.html'">Checkout page</label>
            </div>
          </div>
        </div>
      </div>

      <input type="checkbox" id="full_modal" class="modal-toggle">
      <div class="modal" role="dialog">
        <div class="modal-box max-w-sm">
          <div class="text-center pt-5">
            <div class="flex w-full items-center justify-center">
              <div class="w-8 h-8 rounded-full bg-red-500 text-white justify-center flex items-center">
                <span class="solar--close-square-bold"></span>
              </div>
            </div>
            <h3 class="font-bold text-lg">Restaurant Are Full ?</h3>
            <p class="pb-4 pt-1">You cant enter to this restaurant</p>
          </div>
          <div class="modal-action grid grid-cols-2">
            <div>
              <button class="btn w-full" onclick="window.location.reload()">Reload</button>
            </div>
            <div>
              <button onclick="exitRestaurant()" class="btn bg-red-500 text-white w-full">Exit</button>
            </div>
          </div>
        </div>
      </div>

      <div class="fixed bottom-0 left-0 flex w-full items-center justify-center">
        <div class="max-w-lg w-full p-2 bg-white rounded-t-xl shadow-2xl grid grid-cols-4 items-center gap-x-2">
          <button class="btn btn-sm w-full btn-ghost" onclick="window.location.href = 'index-revision.html'">
            <span class="ic--round-menu-book md:inline-block hidden"></span> <span class="text-xs" id="menu">Menu</span>
          </button>
          <div class="btn btn-sm w-full btn-ghost" onclick="window.location.href = 'checkout-revision.html'">
            <span class="ic--round-shopping-cart-checkout hidden"></span> <span class="text-xs" id="checkout">Checkout</span>
          </div>
          <div class="btn btn-sm w-full btn-ghost" id="language-button">
            <span class="tabler--language hidden"></span> <span class="text-xs" id="language">Language</span>
          </div>
          <div class="btn btn-sm w-full btn-ghost">
            <span class="material-symbols--call md:inline-block hidden"></span> <span class="text-xs" id="call">Call</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</body>
</html>

<script src="component.js"></script>
<script>
let domain_endpoint = 'http://localhost:8000'
let cart_data = JSON.parse(sessionStorage.getItem('foods')) || []
let cart_content = document.getElementById('cart-content')
let ordered = JSON.parse(sessionStorage.getItem('ordered'))
let foods_ordered = JSON.parse(sessionStorage.getItem('foods_ordered'))
let default_language = sessionStorage.getItem('language')
let fetch_header = {
  'Accept': 'application/json',
  'Content-Type': 'application/json'
}
let subtotal_lang = JSON.parse(sessionStorage.getItem('checkout')) || {
  english: 'Subtotal',
}

function increase(food_id) {
  if(cart_data.length > 0) {
    console.log(cart_data)
    console.log(cart_data[food_id])
    let unit = parseInt(cart_data[food_id].unit) 
    cart_data[food_id].unit = unit + 1
    cart_data[food_id].total = parseFloat(cart_data[food_id].price) * parseFloat(cart_data[food_id].unit)
  }
  sessionStorage.setItem('foods', JSON.stringify(cart_data))
  getData()
}

function decrease(food_id) {
  if(cart_data.length > 0) {
    if(parseInt(cart_data[food_id].unit) > 1) {
      let unit = parseInt(cart_data[food_id].unit) 
      cart_data[food_id].unit -= 1
      cart_data[food_id].total = parseFloat(cart_data[food_id].price) * parseFloat(cart_data[food_id].unit)
    }
  }
  sessionStorage.setItem('foods', JSON.stringify(cart_data))
  getData()
}

function deleteFood(food_id) {
  sessionStorage.setItem('tmp_delete', food_id)
  document.getElementById('delete_modal').click()
}

function removeFood() {
  let food_id = sessionStorage.getItem('tmp_delete')
  if(cart_data.length > 0) cart_data.splice(food_id, 1)
  sessionStorage.setItem('foods', JSON.stringify(cart_data))
  getData()
}

function submitCart() {
  let credentials = JSON.parse(sessionStorage.getItem('credentials'))
  let foods = JSON.parse(sessionStorage.getItem('foods'))
  let now = new Date()
  let dateString = now.getUTCFullYear() + "-" +
      ("0" + (now.getUTCMonth()+1)).slice(-2) + "-" +
      ("0" + now.getUTCDate()).slice(-2) + " " +
      ("0" + (now.getUTCHours())).slice(-2) + ":" +
      ("0" + (now.getUTCMinutes())).slice(-2) + ":" +
      ("0" + (now.getUTCSeconds())).slice(-2)
  if((credentials != null || foods != undefined) && (foods != null && foods != undefined)) {
    fetch(domain_endpoint+'/api/1/foods/order/', {
      method: 'POST',
      headers: fetch_header,
      body: JSON.stringify({
        order_time: dateString,
        status: 'pending',
        customer: credentials.customer.id,
        table: credentials.table.number,
      })
    })
    .then((response) => { return response.json() })
    .then((data) => { 
      console.log(data)
      if(data.status == 'success') {
        sessionStorage.setItem('ordered', JSON.stringify(data.data))
        saveFood(data.data.id)
      }
    })
  }
}

function saveFood(id) {
  let foods_orderd = JSON.parse(sessionStorage.getItem('foods_orderd')) || []
  let foods = JSON.parse(sessionStorage.getItem('foods'))
  foods.map((element, index) => {
    fetch(domain_endpoint+'/api/1/foods/order/'+element.id+'/', {
      method: 'POST',
      headers: fetch_header,
      body: JSON.stringify({
        order: id,
        quantity: element.unit
      })
    })
    .then((response) => { return response.json() })
    .then((data) => {
      foods_orderd.push(data.data)
    })
  })
  setTimeout(() => {
    console.log(foods_orderd)
    sessionStorage.setItem('foods_ordered', JSON.stringify(foods_orderd)) 
    document.getElementById('submitted_modal').click()
  }, 500)
}

function getData() {
  if(cart_content) {
    if (cart_data.length == 0) {
        not_found_content = `<div class="flex w-full items-center justify-center py-4">
          <div class="w-full bg-red-500 p-4 rounded-xl text-white flex items-center justify-between">
            <p>You never add a food to cart</p>
            <button onclick="window.location.href = 'index-revision.html'" class="btn bg-white text-red-500 hover:bg-white/70 btn-sm border-0">Menu</button>
          </div>
        </div>`
        cart_content.innerHTML = not_found_content
        document.getElementById('submit-button').classList.add('hidden')
    } else {
      sum_total_price = 0
      sum_total_item = 0
      content = `<div class="space-y-2">`
      cart_data.map((element, index) => {
        let string_subtotal = element.total.toString()
        let format_subtotal = string_subtotal.replace(',', '') || element.total
        sum_total_price += parseFloat(format_subtotal) 
        sum_total_item += parseInt(element.unit)
        content += `<div class="w-full bg-orange-100 hover:bg-white transition-all p-3 rounded-xl">
          <div class="grid md:grid-cols-3 grid-cols-2 items-center justify-between">
            <div class="flex relative items-center justify-start gap-x-2">
              <img src="${element.image}" class="w-16 h-16 object-cover object-center rounded-lg" alt="Image Food">
              <div>
                <p class="font-semibold">${default_language == 'en' ? element.en : default_language == 'ja' ? element.ja : element.mm}</p>
                <span class="text-xs">${element.price} (Yen) <span class="bg-orange-500 absolute left-0 bottom-0 p-1 text-white rounded">X${element.unit}</span> </span>
              </div>
            </div>
            <div>
              <div class="text-center">
                <div class="text-xs">${default_language == 'en' ? subtotal_lang.english : default_language == 'ja' ? subtotal_lang.japan : subtotal_lang.myanmar}</div>
                <div class="text-sm font-bold">${element.total}</div>
              </div>
            </div>
            <div class="md:col-span-1 col-span-2 cart-option">
              <div class="text-right">
                <button class="btn bg-orange-500 btn-sm text-white" onclick="increase(${index})">+</button>
                <button class="btn bg-orange-500 px-[1em] btn-sm text-white" onclick="decrease(${index})">-</button>
                <div class="mt-1 md:block inline-block">
                  <button onclick="deleteFood(${index})" class="btn text-white bg-red-500 btn-sm md:px-[1.85rem] px-2"><span class="fluent--delete-12-filled"></span></button>
                </div>
              </div>
            </div>
          </div>
        </div>`
      })
      content += `</div>`
      content += `<div class="flex mt-2 mb-1 justify-end items-center text-sm">
        <div id="total_item_content">Total Item</div>
        <div class="w-1/4 text-right font-bold">${sum_total_item}</div>
      </div>`
      content += `<div class="flex mb-1 justify-end items-center text-sm">
        <div id="total_price_content">Total Price</div>
        <div class="w-1/4 text-right font-bold">${new Intl.NumberFormat('ja-JP').format(sum_total_price)} Yen</div>
      </div>`
      cart_content.innerHTML = content
      setTimeout(() => {
        if((ordered != null || ordered != undefined) && (foods_ordered != null || foods_ordered != undefined)) {
          document.getElementById('submit-button').classList.add('hidden')
          let optionsCart = document.querySelectorAll('.cart-option')
          console.log(optionsCart)
          optionsCart.forEach((element, index) => {
            element.classList.add('hidden')
            console.log(element)
          })
          document.getElementById('submitted_modal').click()
        }
      }, 500) 
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  getData()
})
</script>